<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="/assets/icons/coffee_bean_icon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커피 메뉴 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="w-full mx-auto my-10 md:p-8 bg-white shadow-lg rounded-lg">
    <header class="text-center mb-10">
        <h1 class="text-3xl font-extrabold text-gray-700">커피 메뉴 관리</h1>
        <p class="text-gray-500 mt-2">메뉴 정보를 확인하고 재료를 관리하세요</p>
    </header>
    <main class="space-y-8">
        <div id="tabs" class="border-b border-gray-200 mb-4">
            <button
                    class="tab-btn py-2 px-4 text-gray-600 border-b-2 border-transparent hover:text-blue-500"
                    data-tab="tab1"
            >
                메뉴목록
            </button>
            <button
                    class="tab-btn py-2 px-4 text-gray-600 border-b-2 border-transparent hover:text-blue-500"
                    data-tab="tab2"
            >
                메뉴등록
            </button>
            <button
                    class="tab-btn py-2 px-4 text-gray-600 border-b-2 border-transparent hover:text-blue-500"
                    data-tab="tab3"
            >
                메뉴조작
            </button>
        </div>

        <div id="tab-content">
            <!--메뉴 등록 START-->
            <div class="tab-panel hidden" id="tab1">
                <!-- 메뉴 리스트 -->
                <div id="menu-list" class="space-y-4">
                    <!-- 메뉴 아이템이 추가되는 위치 -->
                </div>
            </div>
            <!--메뉴 등록 END-->
            <!--메뉴 목록 START-->
            <div class="tab-panel hidden" id="tab2">
                <!-- 신규 메뉴 추가 -->
                <div class="menu-new-item-wrapper overflow-x-auto">
                    <div class="menu-new-item flex flex-col gap-6 p-4 sm:p-6 bg-gray-100 border border-gray-300 rounded-lg shadow-sm">
                        <!-- 메뉴 상세 -->
                        <div class="menu-details flex flex-col gap-6 flex-1">
                            <div class="fixed-row grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-2">
                                <!-- 이미지 -->
                                <div class="menu-image relative w-40 h-40 item flex flex-col bg-gray-200 border border-gray-300 rounded-md">
                                    <img src="../../assets/basicImage/300x300.png" alt="이미지" class="w-full h-full object-cover rounded-lg hover:cursor-pointer" id="imagePreview">
                                    <!-- New 이미지 -->
                                    <img id="newImage" src="" alt="New Image" class="absolute top-0 left-0 w-full h-full object-cover hidden">

                                    <!-- Event 이미지 -->
                                    <img id="eventImage" src="" alt="Event Image" class="absolute top-0 left-0 w-full h-full object-cover hidden">

                                    <!-- Best 이미지 -->
                                    <img id="bestImage" src="" alt="Best Image" class="absolute top-0 left-0 w-full h-full object-cover hidden">
                                    <input type="file" accept="image/*" class="hidden" id="fileInput" />
                                </div>

                                <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                                    <label for="no" class="text-sm text-gray-600">순번</label>
                                    <input id="no" type="number" class="w-full border border-gray-400 rounded-md px-2 py-1">
                                    <label for="name" class="text-sm text-gray-600">메뉴명</label>
                                    <input id="name" type="text" class="w-full border border-gray-400 rounded-md px-2 py-1" maxlength="20">
                                </div>
                                <!-- 카테고리 -->
                                <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                                    <label for="category" class="text-sm text-gray-600">카테고리</label>
                                    <select id="category" name="Category" class="w-full border border-gray-400 rounded-md px-2 py-1">
                                        <option value="coffee">커피</option>
                                        <option value="tea">티</option>
                                        <option value="ade">에이드</option>
                                        <option value="other">기타음료</option>
                                    </select>
                                    <label for="price" class="text-sm text-gray-600">금액</label>
                                    <input type="number" id="price" name="price" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" max="1000000">
                                </div>
                                <!-- 컵 -->
                                <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                                    <label class="text-sm text-gray-600">컵</label>
                                    <fieldset class="flex items-center gap-2">
                                        <label for="cupPlastic" class="flex items-center gap-2">
                                            <input type="radio" id="cupPlastic" name="cup" value="plastic" checked>
                                            <span>플라스틱</span>
                                        </label>
                                        <label for="cupPaper" class="flex items-center gap-2">
                                            <input type="radio" id="cupPaper" name="cup" value="paper">
                                            <span>종이컵</span>
                                        </label>
                                    </fieldset>
                                    <label class="text-sm text-gray-600">얼음</label>
                                    <fieldset class="flex items-center gap-2">
                                        <label for="iceYes" class="flex items-center gap-2">
                                            <input type="radio" id="iceYes" name="iceYn" value="yes" checked>
                                            <span>Yes</span>
                                        </label>
                                        <label for="iceNo" class="flex items-center gap-2">
                                            <input type="radio" id="iceNo" name="iceYn" value="no">
                                            <span>No</span>
                                        </label>
                                    </fieldset>
                                </div>
                                <!-- 얼음 시간 및 물 시간 -->
                                <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                                    <label for="iceTime" class="text-sm text-gray-600">얼음 시간</label>
                                    <input type="number" id="iceTime" name="iceTime" min="0" step="0.5" max="10" class="w-full border border-gray-400 rounded-md px-2 py-1">
                                    <label for="waterTime" class="text-sm text-gray-600">물 시간</label>
                                    <input type="number" id="waterTime" name="waterTime" min="0" step="0.5" max="10" class="w-full border border-gray-400 rounded-md px-2 py-1">
                                </div>
                                <!-- 상태 -->
                                <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                                    <label class="text-sm text-gray-600">상태</label>
                                    <fieldset class="flex flex-col gap-2">
                                        <div class="flex items-center gap-2">
                                            <label for="new" class="text-sm">New</label>
                                            <select id="new" name="new" class="w-full border border-gray-400 rounded-md px-2 py-1">
                                                <option value="" selected>선택</option>
                                                <option value="new1">New1</option>
                                                <option value="new2">New2</option>
                                                <option value="new3">New3</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <label for="event" class="text-sm">Event</label>
                                            <select id="event" name="event" class="w-full border border-gray-400 rounded-md px-2 py-1">
                                                <option value="" selected>선택</option>
                                                <option value="event1">Event1</option>
                                                <option value="event2">Event2</option>
                                                <option value="event3">Event3</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <label for="best" class="text-sm">Best</label>
                                            <select id="best" name="best" class="w-full border border-gray-400 rounded-md px-2 py-1">
                                                <option value="" selected>선택</option>
                                                <option value="best1">Best1</option>
                                                <option value="best2">Best2</option>
                                                <option value="best3">Best3</option>
                                            </select>
                                        </div>
                                    </fieldset>
                                </div>
                                <!-- 품절 -->
                                <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                                    <label class="text-sm text-gray-600">empty</label>
                                    <fieldset class="flex items-center gap-2">
                                        <label for="emptyYes" class="flex items-center gap-2">
                                            <input type="radio" id="emptyYes" name="empty" value="yes" >
                                            <span>Yes</span>
                                        </label>
                                        <label for="emptyNo" class="flex items-center gap-2">
                                            <input type="radio" id="emptyNo" name="empty" value="no" checked>
                                            <span>No</span>
                                        </label>
                                    </fieldset>
                                </div>
                            </div>

                            <!-- 아이템 추가 버튼 -->
                            <div id="itemContainer" class="flex flex-col grid-cols-2 sm:flex-row gap-4">
                                <div id="bitContainer" class="flex flex-col gap-4 w-48 ">
                                    <button id="addItemBtn" class="flex gap-4 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 self-start">
                                        + 항목 추가
                                    </button>
                                    <button id="saveItemBtn" class="flex gap-4 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 self-start">
                                        저장
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--메뉴 목록 END-->
            <!--메뉴 조작 START-->
            <div class="tab-panel hidden" id="tab3">
                <p class="p-4 bg-white border border-gray-200 rounded">Content for Tab 3</p>
            </div>
            <!--메뉴 조작 END-->
        </div>
    </main>
</div>

<script>
    const url = window.location.hostname;
    /* [MENU SET] 등록 메뉴 조회 START */
    /* [MENU SET] 등록 메뉴 삭제 버튼 START */
    document.addEventListener('click', async (event) => {
        // 클릭한 요소가 삭제 버튼인지 확인
        if (event.target.matches('button[id^="deleteItemBtn"]')) {
            const userId = event.target.getAttribute('data-user-id');
            const menuId = event.target.getAttribute('data-menu-id');

            if (userId && menuId) {
                try {

                    // API 요청
                    const response = await fetch(`http://${url}:3000/delete-menu`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', // JSON 데이터임을 명시
                        },
                        body: JSON.stringify({
                            userId: userId,
                            menuId: menuId,
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        console.log('삭제 성공:', result.data);
                        alert('삭제 성공');
                        location.reload();
                        // 삭제 완료 후 UI 업데이트 로직 추가
                    } else {
                        console.error('삭제 실패:', result.message);
                        alert('삭제 실패: ' + result.message);
                    }
                } catch (error) {
                    console.error('삭제 중 오류:', error);
                    alert('삭제 중 오류 발생');
                }
            }
        }
    });
    /* [MENU SET] 등록 메뉴 삭제 버튼 END */
    /* [MENU SET] 등록 메뉴 조회 END */

    /* [MENU SET] 등록 START */
    /* [MENU SET] 등록 IMAGE START */
    // 이미지 클릭 시 input 트리거
    const imagePreview = document.getElementById('imagePreview');
    const fileInput = document.getElementById('fileInput');

    imagePreview.addEventListener('click', () => {
        fileInput.click();
    });

    document.getElementById('fileInput').addEventListener('change', (event) => {
        const file = event.target.files[0];
        const img = document.getElementById('uploadedImage');
        const maxFileSize = 2 * 1024 * 1024; // 파일 크기 제한: 2MB

        if (file) {
            // 파일 크기 제한 확인
            if (file.size > maxFileSize) {
                alert('파일 크기는 2MB를 초과할 수 없습니다.');
                event.target.value = ''; // 파일 선택 취소
                return;
            }

            // 이미지의 URL 생성
            const imgUrl = URL.createObjectURL(file);
            const imgElement = new Image();

            imgElement.src = imgUrl;

            imgElement.onload = () => {
                const { width, height } = imgElement;

                // 이미지 픽셀 크기 제한 (예: 300x300)
                if (width > 600 || height > 600) {
                    alert('이미지 크기는 600x600 이하로 제한됩니다.');
                    event.target.value = ''; // 파일 선택 취소
                } else {
                    imagePreview.src = imgUrl; // 제한 통과 시 이미지 표시
                }
            };
        }
    });

    const selectElements = document.querySelectorAll('select');
    const newImage = document.getElementById('newImage');
    const eventImage = document.getElementById('eventImage');
    const bestImage = document.getElementById('bestImage');

    // 이미지 매핑
    const imageMap = {
        new1:   '../../assets/basicImage/new1.png', // new1   이미지 URL
        new2:   '../../assets/basicImage/new2.png', // new2   이미지 URL
        new3:   '../../assets/basicImage/new3.png', // new3   이미지 URL
        event1: '../../assets/basicImage/event1.png', // event1 이미지 URL
        event2: '../../assets/basicImage/event2.png', // event2 이미지 URL
        event3: '../../assets/basicImage/event3.png', // event3 이미지 URL
        best1:  '../../assets/basicImage/best1.png', // best1  이미지 URL
        best2:  '../../assets/basicImage/best2.png', // best2  이미지 URL
        best3:  '../../assets/basicImage/best3.png'  // best3  이미지 URL
    };

    // 이벤트 리스너 등록
    selectElements.forEach(select => {
        select.addEventListener('change', (event) => {
            const selectedValue = event.target.value;

            if (event.target.id === 'new') {
                newImage.src = imageMap[selectedValue] || '';
                newImage.classList.toggle('hidden', !imageMap[selectedValue]);
            } else if (event.target.id === 'event') {
                eventImage.src = imageMap[selectedValue] || '';
                eventImage.classList.toggle('hidden', !imageMap[selectedValue]);
            } else if (event.target.id === 'best') {
                bestImage.src = imageMap[selectedValue] || '';
                bestImage.classList.toggle('hidden', !imageMap[selectedValue]);
            }
        });
    });
    /* [MENU SET] 등록 IMAGE END */
    /* [MENU SET] 등록 ITEM 추가, 삭제 START */
    // 신규 등록 시작
    let itemCounter = 0; // 항목 번호를 위한 변수

    document.getElementById('addItemBtn').addEventListener('click', () => {
        // 순번 증가
        itemCounter++;

        // 새로운 항목 생성
        const newFieldset = document.createElement('fieldset');
        newFieldset.id = `item${itemCounter}`;
        newFieldset.className = 'menu-new-item flex flex-wrap gap-0.5 p-2 bg-gray-200 border border-gray-300 rounded-md shadow-sm w-52';

        // 새 항목의 HTML 템플릿
        newFieldset.innerHTML = `
    <legend class="text-sm font-semibold mb-2">${itemCounter}항목</legend>
    <div class="menu-details grid grid-cols-2 gap-4 w-full">
        <!-- 타입 선택 -->
        <div>
            <label for="itemType${itemCounter}" class="text-sm text-gray-600">타입</label>
            <select id="itemType${itemCounter}" name="itemType${itemCounter}" class="w-full border border-gray-400 rounded-md px-2 py-1 itemTypeSelector">
                <option value="" selected disabled hidden>선택</option>
                <option value="coffee">커피</option>
                <option value="garucha">가루차</option>
                <option value="syrup">시럽</option>
            </select>
        </div>

        <!-- 삭제 버튼 -->
        <div class="flex items-center justify-end">
            <button type="button" class="deleteItemBtn bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600">
                삭제
            </button>
        </div>
    </div>

    <!-- 동적으로 변경될 필드 -->
    <div id="dynamicFields${itemCounter}" class="dynamic-fields grid grid-cols-2 gap-4 w-full mt-4">
    </div>
    `;

        // 버튼 앞에 새 항목 삽입
        const itemContainer = document.getElementById('itemContainer');
        const bitContainer = document.getElementById('bitContainer');
        itemContainer.insertBefore(newFieldset, bitContainer);

        // select의 change 이벤트 등록
        const selectElement = newFieldset.querySelector(`#itemType${itemCounter}`);
        selectElement.addEventListener('change', ((currentItemId) => {
            return (event) => {
                updateItemFields(currentItemId, event.target.value);
            };
        })(itemCounter));
    });

    // 삭제 버튼 이벤트 리스너 추가
    document.getElementById('itemContainer').addEventListener('click', (event) => {
        if (event.target.classList.contains('deleteItemBtn')) {
            const fieldset = event.target.closest('fieldset');
            fieldset.remove();
        }
    });

    // 삭제 버튼 이벤트 리스너 추가
    document.getElementById('itemContainer').addEventListener('click', (event) => {
        if (event.target.classList.contains('deleteItemBtn')) {
            const fieldset = event.target.closest('fieldset');
            fieldset.remove();
        }
    });
    /* [MENU SET] 등록 ITEM 추가, 삭제 END */

    /* [MENU SET] 등록 ITEM 동적 등록 START */
    // 선택값에 따라 필드 업데이트
    function updateItemFields(itemId, selectedType) {
        const dynamicFields = document.getElementById(`dynamicFields${itemId}`);

        // 동적 필드 내용 설정
        let newFieldsHTML = '';
        if (selectedType === 'coffee') {
            newFieldsHTML = `
            <div>
                <label for="value1-${itemId}" class="text-sm text-gray-600">글라인더1</label>
                <input type="number" id="value1-${itemId}" name="value1-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="10">
            </div>
            <div>
                <label for="value2-${itemId}" class="text-sm text-gray-600">글라인더2</label>
                <input type="number" id="value2-${itemId}" name="value2-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="10">
            </div>
            <div>
                <label for="value3-${itemId}" class="text-sm text-gray-600">추출량</label>
                <input type="number" id="value3-${itemId}" name="value3-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="100" />
            </div>
            <div>
                <label for="value4-${itemId}" class="text-sm text-gray-600">핫워터</label>
                <input type="number" id="value4-${itemId}" name="value4-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="200">
            </div>`;
        } else if (selectedType === 'garucha') {
            newFieldsHTML = `
            <div>
                <label for="value1-${itemId}" class="text-sm text-gray-600">차 종류</label>
                <input type="number" id="value1-${itemId}" name="value1-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" min="1" max="6">
            </div>
            <div>
                <label for="value2-${itemId}" class="text-sm text-gray-600">추출 시간</label>
                <input type="number" id="value2-${itemId}" name="value2-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="100">
            </div>
            <div>
                <label for="value3-${itemId}" class="text-sm text-gray-600">핫워터</label>
                <input type="number" id="value3-${itemId}" name="value3-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="200">
            </div>`;
        } else if (selectedType === 'syrup') {
            newFieldsHTML = `
            <div>
                <label for="value1-${itemId}" class="text-sm text-gray-600">시럽 종류</label>
                <input type="text" id="value1-${itemId}" name="value1-${itemId}" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" min="1" max="6">
            </div>
            <div>
                <label for="value2-${itemId}" class="text-sm text-gray-600">펌프 시간</label>
                <input type="number" id="value2-${itemId}" name="value2-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="10">
            </div>
            <div>
                <label for="value3-${itemId}" class="text-sm text-gray-600">핫워터</label>
                <input type="number" id="value3-${itemId}" name="value3-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="100">
            </div>
            <div>
                <label for="value4-${itemId}" class="text-sm text-gray-600">탄산수</label>
                <input type="number" id="value4-${itemId}" name="value4-${itemId}" min="0" class="w-full border border-gray-400 rounded-md px-2 py-1" value="0" max="100">
            </div>`;
        }

        // 기존 필드를 새로 생성된 내용으로 대체
        dynamicFields.innerHTML = newFieldsHTML;
    }

    /* [MENU SET] 등록 ITEM 동적 등록 END */


    /* [MENU SET] 등록 버튼 START */
    document.getElementById('saveItemBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('fileInput');

        // 메인 메뉴 데이터 수집
        const menuData = {
            no: Number(document.getElementById('no').value) || 0,
            name: document.getElementById('name').value || '',
            category: document.getElementById('category').value || '',
            price: document.getElementById('price').value || '0',
            cup: document.querySelector('input[name="cup"]:checked')?.value || '',
            iceYn: document.querySelector('input[name="iceYn"]:checked')?.value || '',
            empty: document.querySelector('input[name="empty"]:checked')?.value || 'no',
            iceTime: document.getElementById('iceTime').value || '0',
            waterTime: document.getElementById('waterTime').value || '0',
            state: {
                new: document.getElementById('new').value || '',
                best: document.getElementById('best').value || '',
                event: document.getElementById('event').value || ''
            },
            items: [],
            image: "" // 임시 이미지 URL
        };

        // items 데이터 수집
        let itemCounter = 0; // 항목 번호를 위한 카운터
        document.querySelectorAll('#itemContainer fieldset').forEach((fieldset) => {
            itemCounter++;

            const itemType = fieldset.querySelector('select')?.value || '';
            const value1 = fieldset.querySelector('[name*="value1"]')?.value || '0';
            const value2 = fieldset.querySelector('[name*="value2"]')?.value || '0';
            const value3 = fieldset.querySelector('[name*="value3"]')?.value || '0';
            const value4 = fieldset.querySelector('[name*="value4"]')?.value || '0';

            const itemData = {
                no: itemCounter,
                type: itemType,
                value1,
                value2,
                value3,
                value4
            };

            menuData.items.push(itemData); // items 배열에 추가
        });

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('image', file);
            formData.append('menuData', JSON.stringify(menuData));
            console.log(JSON.stringify(menuData));
            try {
                const response = await fetch(`http://${url}:3000/set-admin-menu-info`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                if (result.success) {
                    console.log('업로드 성공:', result.data);
                    alert("업로드 성공");
                    location.reload();
                } else {
                    console.error('업로드 실패:', result.message);
                    alert('업로드 실패: '+ result.message);
                }
            } catch (error) {
                console.error('업로드 중 오류:', error);
                alert('업로드 중 오류: '+ error);
            }
        } else {
            alert('이미지를 선택해주세요.');
        }
    });
    /* [MENU SET] 등록 버튼 END */
    /* [MENU SET] 등록 END */


    /* 텝 컨트롤 START */
    document.addEventListener('DOMContentLoaded', () => {
        const tabs = document.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('.tab-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.getAttribute('data-tab');

                // 모든 탭과 패널 초기화
                tabs.forEach(t => t.classList.remove('text-blue-500', 'border-blue-500'));
                panels.forEach(panel => panel.classList.add('hidden'));

                // 선택된 탭과 패널 활성화
                tab.classList.add('text-blue-500', 'border-blue-500');
                document.getElementById(target).classList.remove('hidden');
            });
        });

        // 첫 번째 탭 활성화
        tabs[0].click();
    });
    /* 텝 컨트롤 END */
</script>

<script type="module" src="/renderer/api/menuApi.browser.js"></script>
<script type="module">
    import { getMenuInfoAll, fetchCupPlUse, fetchCupPaUse, fetchIceRun, fetchIceTime, fetchWaterTime } from '/renderer/api/menuApi.browser.js';
    const url = window.location.hostname;
    const userUrlPort = `http://${url}:3000`
    let data;
    // 메뉴 요청 START

    // 컵 클릭 처리
    window.handleCupClick = async function (menuId) {

        // 전체 데이터에서 해당 menuId의 데이터 추출
        const targetItem = data.Items.find((item) => item.menuId === parseInt(menuId));

        if (!targetItem) {
            console.error(`Item with menuId ${menuId} not found`);
            return;
        }

        if (!confirm(`[${targetItem.name}] 컵을 투출합니다`)) {
            return;
        }

        // 컵 데이터 확인 및 API 호출
        if (targetItem.cup === "plastic") {
            console.log(`플라스틱 컵 선택: ${JSON.stringify(targetItem)}`);
            await callApi(fetchCupPlUse, menuId, targetItem);
        } else if (targetItem.cup === "paper") {
            console.log(`종이컵 선택: ${JSON.stringify(targetItem)}`);
            await callApi(fetchCupPaUse, menuId, targetItem);
        } else {
            console.error("Unknown cup type:", targetItem.cup);
        }
    };

    // 얼음 및 물 투출 처리
    window.handleIceWaterClick = async function (menuId) {
        // 전체 데이터에서 해당 menuId의 데이터 추출
        const targetItem = data.Items.find((item) => item.menuId === parseInt(menuId));

        if (!targetItem) {
            console.error(`Item with menuId ${menuId} not found`);
            return;
        }

        if (!confirm(`[${targetItem.name}] 얼음과 물을 투출합니다.`)) {
            return;
        }

        try {
            // 얼음 투출 (iceYn이 "yes"일 경우)
            if (targetItem.iceYn === "yes") {
                console.log(`얼음 시간: ${targetItem.iceTime}`);
                await fetchIceTime(targetItem.iceTime); // 얼음 시간 설정
            }

            // 물 투출 (waterTime 설정)
            console.log(`물 시간: ${targetItem.waterTime}`);
            await fetchWaterTime(targetItem.waterTime); // 물 시간 설정

            // 최종 실행
            console.log("얼음/물 투출 실행");
            await fetchIceRun(); // 최종 실행

            alert(`[${targetItem.name}] 얼음 및 물 투출이 완료되었습니다.`);
        } catch (error) {
            console.error(`얼음 및 물 투출 중 오류 발생:`, error);
            alert(`[${targetItem.name}] 얼음 및 물 투출 중 오류가 발생했습니다.`);
        }
    };

    // API 호출 함수
    window.callApi = async function (apiFunction, menuId, data) {
        try {
            const response = await apiFunction(menuId);
            console.log(response);
            if (response.status === 200) {
                const result = await response.json();
                console.log(`API 호출 성공:`, result);
                alert(`API 호출 성공! 데이터: ${JSON.stringify(result)}`);
            } else {
                console.error(`API 호출 실패: ${response.statusText}`);
                alert("API 호출 실패!");
            }
        } catch (error) {
            console.error("API 호출 중 오류 발생:", error);
            alert("API 호출 중 오류 발생!");
        }
    }

    // 메뉴 요청 END
    // 메뉴그리기 START
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            data = await getMenuInfoAll();
            const menuListContainer = document.getElementById("menu-list");

            if (Array.isArray(data?.Items)) {
                const menuHTML = data.Items.map(item => createMenuHTML(item)).join('');
                menuListContainer.innerHTML = menuHTML;
            } else {
                console.warn('No menu items found.');
            }

            console.log('Menu Info:', data);
        } catch (error) {
            console.error('Error fetching menu info:', error);
        }
    });

    // 반복적으로 메뉴 아이템 HTML 생성
    const createMenuHTML = (menuData) => {
        const escapeHTML = (str) => {
            return str.replace(/[&<>"']/g, (match) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
            }[match]));
        };

        const convertToImageUrl = (localPath) => {
            const fileName = localPath.split('\\').pop(); // 파일 이름 추출
            return `${userUrlPort}/images/${fileName}`;
        };

        const imageUrl = convertToImageUrl(menuData.image); // 이미지 경로 변환

        return `
    <div class="menu-new-item-wrapper overflow-x-auto">
        <div class="menu-new-item flex flex-col gap-6 p-4 sm:p-6 bg-gray-100 border border-gray-300 rounded-lg shadow-sm">
            <div class="menu-details flex flex-col gap-6 flex-1">
                <div class="fixed-row grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                    <div class="menu-image relative w-40 h-40 item flex flex-col bg-gray-200 border border-gray-300 rounded-md">
                        <img src="${escapeHTML(imageUrl)}" alt="이미지" class="w-full h-full object-cover rounded-lg hover:cursor-pointer">
                    </div>
                    <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                        <label for="no" class="text-sm text-gray-600">순번</label>
                        <input type="text" class="w-full border border-gray-400 rounded-md px-2 py-1" value="${Number(escapeHTML(menuData.no?.toString() || 0))}" disabled>
                        <label for="name" class="text-sm text-gray-600">메뉴명</label>
                        <input type="text" class="w-full border border-gray-400 rounded-md px-2 py-1" value="${escapeHTML(menuData.name || '')}" disabled>
                    </div>
                    <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                        <label for="category" class="text-sm text-gray-600">카테고리</label>
                        <input type="text" class="w-full border border-gray-400 rounded-md px-2 py-1" value="${escapeHTML(menuData.category || '')}" disabled>
                        <label for="price" class="text-sm text-gray-600">금액</label>
                        <input type="text" class="w-full border border-gray-400 rounded-md px-2 py-1" value="${escapeHTML(menuData.price?.toString() || '')}" disabled>
                    </div>
                     <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2 cup-item" data-menu-id="${menuData.menuId}"
     onclick="handleCupClick(${menuData.menuId})">
                        <label class="text-sm text-gray-600">컵</label>
                        <fieldset class="flex items-center gap-2">
                            <label for="cupPlastic" class="flex items-center gap-2">
                                <input type="radio" name="cup-${menuData.menuId}" value="plastic" ${menuData.cup === 'plastic' ? 'checked' : ''} disabled>
                                <span>플라스틱</span>
                            </label>
                            <label for="cupPaper" class="flex items-center gap-2">
                                <input type="radio" name="cup-${menuData.menuId}" value="paper" ${menuData.cup === 'paper' ? 'checked' : ''} disabled>
                                <span>종이컵</span>
                            </label>
                        </fieldset>
                        <label class="text-sm text-gray-600">얼음</label>
                        <fieldset class="flex items-center gap-2">
                            <label for="iceYes" class="flex items-center gap-2">
                                <input type="radio" name="iceYn-${menuData.menuId}" value="yes" ${menuData.iceYn === 'yes' ? 'checked' : ''} disabled>
                                <span>Yes</span>
                            </label>
                            <label for="iceNo" class="flex items-center gap-2">
                                <input type="radio" name="iceYn-${menuData.menuId}" value="no" ${menuData.iceYn === 'no' ? 'checked' : ''} disabled>
                                <span>No</span>
                            </label>
                        </fieldset>
                    </div>
                    <!-- 얼음 시간 및 물 시간 -->
                    <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2" data-menu-id="${menuData.menuId}"
     onclick="handleIceWaterClick(${menuData.menuId})">
                        <label for="iceTime-${menuData.menuId}" class="text-sm text-gray-600">얼음 시간</label>
                        <input type="number" name="iceTime" min="0" step="0.5" max="10" value="${menuData.iceTime || ''}" class="w-full border border-gray-400 rounded-md px-2 py-1" disabled>
                        <label for="waterTime-${menuData.menuId}" class="text-sm text-gray-600">물 시간</label>
                        <input type="number" name="waterTime" min="0" step="0.5" max="10" value="${menuData.waterTime || ''}" class="w-full border border-gray-400 rounded-md px-2 py-1" disabled>
                    </div>
                    <!-- 상태 -->
                    <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                        <label class="text-sm text-gray-600">상태</label>
                        <fieldset class="flex flex-col gap-2">
                            <div class="flex items-center gap-2">
                                <label for="new-${menuData.menuId}" class="text-sm">New</label>
                                <select name="new" class="w-full border border-gray-400 rounded-md px-2 py-1" disabled>
                                    <option value="" ${!menuData.state?.new ? 'selected' : ''}>선택</option>
                                    <option value="new1" ${menuData.state?.new === 'new1' ? 'selected' : ''}>New1</option>
                                    <option value="new2" ${menuData.state?.new === 'new2' ? 'selected' : ''}>New2</option>
                                    <option value="new3" ${menuData.state?.new === 'new3' ? 'selected' : ''}>New3</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="event-${menuData.menuId}" class="text-sm">Event</label>
                                <select name="event" class="w-full border border-gray-400 rounded-md px-2 py-1" disabled>
                                    <option value="" ${!menuData.state?.event ? 'selected' : ''}>선택</option>
                                    <option value="event1" ${menuData.state?.event === 'event1' ? 'selected' : ''}>Event1</option>
                                    <option value="event2" ${menuData.state?.event === 'event2' ? 'selected' : ''}>Event2</option>
                                    <option value="event3" ${menuData.state?.event === 'event3' ? 'selected' : ''}>Event3</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="best-${menuData.menuId}" class="text-sm">Best</label>
                                <select name="best" class="w-full border border-gray-400 rounded-md px-2 py-1" disabled>
                                    <option value="" ${!menuData.state?.best ? 'selected' : ''}>선택</option>
                                    <option value="best1" ${menuData.state?.best === 'best1' ? 'selected' : ''}>Best1</option>
                                    <option value="best2" ${menuData.state?.best === 'best2' ? 'selected' : ''}>Best2</option>
                                    <option value="best3" ${menuData.state?.best === 'best3' ? 'selected' : ''}>Best3</option>
                                </select>
                            </div>
                        </fieldset>
                    </div>
                    <div class="item flex flex-col bg-gray-200 border border-gray-300 rounded-md p-2">
                        <!-- 삭제 버튼 -->
                        <button
                            id="deleteItemBtn-${menuData.menuId}"
                            class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600"
                            data-user-id="${menuData.userId}"
                            data-menu-id="${menuData.menuId}">
                            삭제
                        </button>
                    </div>
                </div>

                <div class="items-list grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 mt-4">
    ${menuData.items?.map(item => `
        <fieldset class="menu-item bg-gray-200 border border-gray-300 rounded-md p-2">
            <legend class="text-sm font-semibold mb-2">항목 ${escapeHTML(item.no?.toString() || '')}</legend>
            <div>타입: ${item.type === 'coffee' ? '커피' : item.type === 'garucha' ? '가루차' : item.type === 'syrup' ? '시럽' : '알 수 없음'}</div>
            ${item.type === 'coffee' ? `
                <div>
                    <label class="text-sm text-gray-600">글라인더1</label>
                    <input type="text" value="${escapeHTML(item.value1?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
                <div>
                    <label class="text-sm text-gray-600">글라인더2</label>
                    <input type="text" value="${escapeHTML(item.value2?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
                <div>
                    <label class="text-sm text-gray-600">추출량</label>
                    <input type="text" value="${escapeHTML(item.value3?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
                <div>
                    <label class="text-sm text-gray-600">핫워터</label>
                    <input type="text" value="${escapeHTML(item.value4?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
            ` : item.type === 'garucha' ? `
                <div>
                    <label class="text-sm text-gray-600">차종류</label>
                    <input type="text" value="${escapeHTML(item.value1?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
                <div>
                    <label class="text-sm text-gray-600">추출시간</label>
                    <input type="text" value="${escapeHTML(item.value2?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
                <div>
                    <label class="text-sm text-gray-600">핫워터</label>
                    <input type="text" value="${escapeHTML(item.value3?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
            ` : item.type === 'syrup' ? `
                <div>
                    <label class="text-sm text-gray-600">시럽종류</label>
                    <input type="text" value="${escapeHTML(item.value1?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
                <div>
                    <label class="text-sm text-gray-600">펌프시간</label>
                    <input type="text" value="${escapeHTML(item.value2?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
                <div>
                    <label class="text-sm text-gray-600">핫워터</label>
                    <input type="text" value="${escapeHTML(item.value3?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
                <div>
                    <label class="text-sm text-gray-600">탄산수</label>
                    <input type="text" value="${escapeHTML(item.value4?.toString() || '')}" class="w-full border border-gray-400 rounded-md px-2 py-1" readonly>
                </div>
            ` : `
                <div>
                    <span class="text-sm text-gray-600">Unknown Type</span>
                </div>
            `}
        </fieldset>
    `).join('') || ''}
</div>
            </div>
        </div>
    </div>`;
    };
// 메뉴그리기 END
</script>
<!-- menuApi.js를 먼저 로드 -->
<script src="/renderer/web/modelAdmin.js"></script>
</body>
</html>
